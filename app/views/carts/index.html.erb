<div class="container">
    <div class="row">
      <h1><%= current_user.name %>'s Cart</h1>
    </div>
    
    <% if @carts.empty? %>
    <div class="row">
      <h2>カートには何も入っていません</h2>
    </div>
    <% else %>
    
    <% if flash[:notice] %>
    <div class="row">
      <div class="col-sm-12">
        <div class="alert alert-danger">
          <%= flash[:notice] %>
        </div>
      </div>
    </div>
    <% end %>
    
    <div class="row">
      <div class="col-lg-9">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>No</th>
              <th>商品名</th>
              <th></th>
              <th></th>
              <th></th>
              <th class="text-center">値段</th>
              <th colspan="2" class="text-center">数量</th>
              <th></th>
              <th class="text-center">小計</th>
            </tr>
          </thead>
          <tbody>
            <% @carts.each_with_index do |cart,i| %>
            <tr>
              <td><%= "#{h(i + 1)}" %></td>
              
              <% cart.products.each do |product| %>
              <% if product.product_type == "envelope" %>
                <td>
                <div class="cart-box">
                  <% if product.main_image.present? %>
                    <%= image_tag(product.main_image) %>
                  <% else %>
                    <%= image_tag("no-image-envelope.png") %>
                  <% end %>
                </div>
                </td>
                <td><%= product.name %><br />
                    <%= product.product_code %></td>
              <% else product.product_type == "card" %>
                <td>
                <div class="cart-box">
                  <% if product.main_image.present? %>
                    <%= image_tag(product.main_image) %>
                  <% else %>
                    <%= image_tag("no-image-card.png") %>
                  <% end %>
                </div>
                </td>
                <td><%= product.name %><br />
                    <%= product.product_code %></td>
              <% end %>
              <% end %>
              
              <td class="text-right"><%= cart.products.sum(:price) %> 円</td>
              
              <% cart.line_items.each do |li| %>
              <% if li.product_type == "envelope" %>
              <td class="text-right"><b><%= li.count %></b></td>
              <td><%= link_to '▲', update_count_up_line_item_path(li), method: :patch %><br />
                  <%= link_to '▼', update_count_down_line_item_path(li), method: :patch %></td>
              <% end %>
              <% end %>
              <td><%= link_to '削除', cart, method: :delete %></td>
              <td class="text-right"><%= cart.amount %> 円</td>  
            </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <div class="col-lg-3"> 
      
      <% if current_user.shipping_prefecture.nil? %>
      
        <div class="form-group">
        <form>
          お支払方法予定：
          <select name="user[payment_type]" onchange="SetSubMenu(value);" class="form-control">
            <option value="" selected>--選択してください--</option>
            <option value="payment01">代金引換</option>
            <option value="payment02">クレジットカード・コンビニ・電子マネー</option>
          </select>
        </form>
        
        <%= form_tag({controller: "users", action: "info_update"}, {id: "payment01", class: "secondpulldown"}) do %>
          送付先：
          <%= collection_select(:userinfo, :shipping_prefecture, Prefecture.all, :id, :name, {}, {:class => "form-control"} ) %>
          <div class="actions">
            <%= submit_tag "Check", class: "btn btn-info btn-sm" %>
          </div>
        <% end %>
        
        <%= form_tag({controller: "users", action: "info_update"}, {id: "payment02", class: "secondpulldown"}) do %>
          全国一律、送料450円
          <%= hidden_field_tag 'userinfo[shipping_prefecture]', 'everyplace' %>
          <div class="actions">
          <%= submit_tag "Check", class: "btn btn-info btn-sm" %>
          </div>
        <% end %>
        
        </div>
        
      <% else %>
        <p>お支払方法予定：<br />　<b><%= @payment_type %></b></p>
        <p>配送種類：<br />　<b><%= @shipping_type %></b></p>
        <p>配送先：<br />　<b><%= @shipping_prefecture %></b></p>
        <%= link_to '>>お支払い方法をリセット', info_destroy_user_path(current_user), :method => :patch %>
        
      <% end %>
        
        <hr />
        
        
        <div class="clearfix">
          <p class="h4 pull-left">商　品：</p>
          <p class="h4 text-right"><%= @add_amount %>円</p>
        </div>
        <div class="clearfix">
          <p class="h4 pull-left">消費税：</p>
        <p class="h4 text-right"><%= @tax %>円</p>
        </div>
        <div class="clearfix">
          <p class="h4 pull-left">送　料：</p>
          <p class="h4 text-right"><%= @postage %>円</p>
        </div>
        <% if @add_amount < 3000 %>
        <div class="panel panel-danger">
          <div class="panel-heading">あと <b><%= 3000 - @add_amount %>円</b>（税抜)で送料無料です！</div>
        </div>
        <% else %>
        <div class="panel panel-success">
          <div class="panel-heading">送料が無料になりました！</div>
        </div>
        <% end %>
        <hr />
        <div class="clearfix">
          <p class="h4 pull-left">総合計：</p>
          <p class="h4 text-right"><%= @total_amount %>円</p>
        </div>

        <%= link_to new_order_url, class: "btn btn-danger btn-lg" do %>
        <i class="glyphicon glyphicon-shopping-cart"></i> ご購入手続き
        <% end %>
      </div>
    </div>
    <% end %>
</div>